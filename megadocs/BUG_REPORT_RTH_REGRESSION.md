# Bug Report: RTH Validation Regression

## 🚨 **CRITICAL ISSUE**

**Status**: 🔴 **ACTIVE REGRESSION**  
**Severity**: **CRITICAL** - All strategies now failing  
**Impact**: **100% failure rate** (0 out of 8 strategies working)  
**Date**: September 5, 2024  

## 📋 **Summary**

A recent fix to the RTH validation logic has introduced a **critical regression** that is now causing **ALL strategies** to fail with RTH validation errors. This represents a complete system failure where previously working strategies are now unable to run.

## 🔍 **Problem Description**

### **Before Fix**
- ✅ 6 out of 8 strategies working correctly
- ✅ RTH validation working with CSV files
- ✅ Only VolatilityExpansion and MarketMaking had threshold issues

### **After Fix**
- ❌ 0 out of 8 strategies working (100% failure rate)
- ❌ All strategies fail at RTH validation stage
- ❌ Even previously working strategies now fail

## 🐛 **Error Details**

**Error Message**:
```
FATAL ERROR: Non-RTH data found after filtering!
 -> Symbol: QQQ
 -> Timestamp (UTC): 2022-09-06T09:30:00-04:00
 -> NYT Epoch: 1662456600
```

**Analysis**:
- **Timestamp**: `2022-09-06T09:30:00-04:00` (9:30 AM ET)
- **Expected**: Valid RTH time (9:30 AM is start of RTH)
- **Actual**: RTH validation rejects this as "Non-RTH data"
- **NYT Epoch**: `1662456600` (incorrect conversion)

## 🔧 **Root Cause Analysis**

### **Timezone Conversion Bug**
The RTH validation logic appears to have a timezone conversion bug:

1. **Input**: `2022-09-06T09:30:00-04:00` (9:30 AM ET)
2. **Expected**: Valid RTH time (9:30 AM is start of RTH)
3. **Actual**: RTH validation rejects this as "Non-RTH data"
4. **NYT Epoch**: `1662456600` (incorrect conversion)

### **Validation Logic Issue**
The RTH validation is incorrectly rejecting valid RTH timestamps:
- 9:30 AM ET is the **start** of Regular Trading Hours
- This should be **accepted** as valid RTH data
- The validation logic is incorrectly flagging this as "Non-RTH"

## 📊 **Impact Assessment**

### **Immediate Impact**
- **All strategies failing**: 0 out of 8 strategies working
- **Complete system failure**: No backtesting possible
- **Regression**: Previously working strategies now broken

### **Affected Components**
- RTH validation logic
- All strategy execution
- Data loading pipeline
- Backtesting framework

## 🛠️ **Reproduction Steps**

1. **Build the project**:
   ```bash
   make clean && make
   ```

2. **Set data suffix**:
   ```bash
   export SENTIO_DATA_SUFFIX="_RTH_NH"
   ```

3. **Test any strategy**:
   ```bash
   ./build/sentio_cli backtest QQQ --strategy VWAPReversion
   ```

4. **Observe failure**:
   ```
   FATAL ERROR: Non-RTH data found after filtering!
   -> Symbol: QQQ
   -> Timestamp (UTC): 2022-09-06T09:30:00-04:00
   -> NYT Epoch: 1662456600
   ```

## 🔍 **Technical Details**

### **Data Files**
- **CSV Format**: `data/equities/QQQ_RTH_NH.csv`
- **Binary Format**: `data/equities/QQQ_RTH_NH.bin`
- **Data Source**: Generated by `tools/data_downloader.py`

### **RTH Validation Logic**
The RTH validation is performed in the data loading pipeline, likely in:
- `src/runner.cpp` (data loading)
- `src/polygon_client.cpp` (data processing)
- RTH validation functions

### **Expected Behavior**
- 9:30 AM ET should be **accepted** as valid RTH time
- RTH validation should only reject times outside 9:30 AM - 4:00 PM ET
- Timezone conversion should correctly handle ET timestamps

## 🎯 **Proposed Solutions**

### **Immediate Fix**
1. **Revert RTH Validation Changes**: Undo the recent changes that introduced the regression
2. **Debug Timezone Conversion**: Fix the timezone conversion logic in RTH validation
3. **Test Individual Strategies**: Verify that previously working strategies work again

### **Long-term Fix**
1. **Comprehensive RTH Validation Testing**: Add unit tests for RTH validation logic
2. **Timezone Conversion Testing**: Test all timezone conversion scenarios
3. **Regression Testing**: Ensure changes don't break existing functionality

## 📈 **Success Criteria**

### **Immediate Success**
- ✅ All previously working strategies work again
- ✅ RTH validation accepts valid RTH timestamps
- ✅ 6 out of 8 strategies working (as before regression)

### **Long-term Success**
- ✅ Robust RTH validation with comprehensive testing
- ✅ No regressions in future changes
- ✅ All strategies working with proper threshold tuning

## 🚨 **Priority**

**CRITICAL** - This regression has caused a complete system failure and must be addressed immediately.

## 📝 **Notes**

- This regression was introduced by recent changes to RTH validation logic
- The issue affects all strategies, not just specific ones
- The timezone conversion appears to be the root cause
- Once fixed, the threshold issues for VolatilityExpansion and MarketMaking can be addressed

## 🔗 **Related Issues**

- **Threshold Issues**: VolatilityExpansion and MarketMaking (pending RTH fix)
- **Data Packing Issue**: Previously resolved
- **Segmentation Faults**: Previously resolved

---

**Report Generated**: September 5, 2024  
**Last Updated**: September 5, 2024  
**Status**: 🔴 **ACTIVE REGRESSION**
